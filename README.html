<h2>Interpolation to pressure levels</h2>
<p>The script <code>ml2pl.sh</code> interpolates history files of LMDZ (files named <code>hist....nc</code>) from model levels to pressure levels. Interpolation is linear in logarithm of pressure. If you want to use this program on the computers jean-zay at IDRIS, or irene at TGCC, or Ciclad at IPSL, the program is already installed at the following paths.</p>
<p>On jean-zay:</p>
<pre>/gpfswork/rech/lmd/rdzt899/bin/ml2pl.sh</pre>
<p>On irene:</p>
<pre>/ccc/work/cont003/gencmip6/guezl/bin/ml2pl.sh</pre>
<p>On Ciclad:</p>
<pre>/data/guez/bin/ml2pl.sh</pre>
<h3>Installation</h3>
<p><code>Ml2pl</code> is written in Fortran 2003 and Bash. So you need a Fortran 2003 compiler and Bash on your machine. Moreover, you need to have the NetCDF library installed, with its Fortran interface. The Fortran interface to the NetCDF library must be installed using the same Fortran compiler than the one you are going to use for <code>Ml2pl</code>.</p>
<ol>
<li><a class="internal-link" href="ml2pl_with_lib-tar-gz">Download the archive</a> with source files. Extract its content:
<pre>tar xvzf Ml2pl_with_lib-tar-gz
</pre>
and change directory:
<pre>cd Ml2pl_with_lib</pre>
</li>
<li>Decide which Fortran 2003 compiler you want to use. Remember that you need the NetCDF library installed with the chosen compiler. If you have version 4 of the NetCDF library installed then the program <code>nf-config</code> should have been installed with the library. (You can also try the command <code>nc-config</code> instead.) This program will tell you the compiler you need to use with your NetCDF library. Just type:
<pre>nf-config --fc</pre>
You indicate your choice of Fortran compiler by setting the environment variable FC. Here is an example of setting the variable <code>FC</code> in Bash:
<pre>export FC=the-output-of-nf-config--fc</pre>
</li>
<li>If the NetCDF library installed with the chosen compiler is not in standard locations, you should set the variables <code>NETCDF_INC_DIR</code> and <code>LDLIBS</code>. The directory <code>$NETCDF_INC_DIR</code> should contain the compiled NetCDF module interfaces (usually <code>netcdf.mod</code> and <code>typesizes.mod</code>). Note that the program does not need <code>netcdf.inc</code>. If you have the command <code>nf-config</code>, type:
<pre>nf-config --includedir</pre>
to find out the value of <code>NETCDF_INC_DIR</code>. For example:
<pre>export NETCDF_INC_DIR=the-output-of-nf-config--includedir</pre>
<code>LDLIBS</code> should give the path to the compiled NetCDF libraries and the name of those libraries, in the form required by your compiler. If you have the command <code>nf-config</code>, type:
<pre>nf-config --flibs</pre>
and paste the result of the command, between quotes, into <code>LDLIBS</code>. For example:
<pre>export LDLIBS="the-output-of-nf-config--flibs"</pre>
Here are a few tips to help you define <code>LDLIBS</code> if you do not have the command <code>nf-config</code> nor the command <code>nc-config</code>. Usually, the path to a library should be given in a <code>-L</code> option and the name of a library should be given in a <code>-l</code> option. So for example the adequate definition could be:
<pre>export LDLIBS="-L/usr/lib -lnetcdf"</pre>
which means that <code>libnetcdf.a</code> is to be found in <code>/user/lib</code>. Depending on your NetCDF installation, the Fortran 90 interface of NetCDF may be included in <code>libnetcdf.a</code> or may be in a separate library (usually <code>libnetcdff.a</code>, with two 'f's). If you have a separate library for the Fortran 90 interface, you have to include the path to it and its name in the variable <code>LDLIBS</code>. For example:
<pre>export LDLIBS="-L/user/lib -L/user/lib/NetCDF_gfortran -lnetcdff -lnetcdf"</pre>
Note that the order of options <code>-l</code> is usually important: the library for the Fortran 90 interface should be referenced first. (The order of options <code>-L</code> usually does not matter.)</li>
<li>Optionally, you may choose additional compiler options by setting the variable <code>FFLAGS</code>. For example:
<pre>export FFLAGS=-O3</pre>
</li>
<li>The parts of makefiles in the directory <code>Compiler_options</code> contain the compiler options for free source form and for reference to <code>NETCDF_INC_DIR</code>. There is one file for each of the following compilers : g95, gfortran, ifort, pgfortran, sxf90, xlf95. If you do not see the compiler you want in this list, you will have to create a similar file for your compiler.<span><b> If the above instructions don't work, please directly edit the makefile corresponding to your netcdf compiler, for example <code>Compiler_options/gfortran.mk</code>.</b></span></li>
<li>The makefiles are written for GNU make. The command invoking GNU make is usually <code>make</code> or <code>gmake</code>. So, for example, type:
<pre>make</pre>
After compilation, the executable binary file <code>ml2pl</code> should be created in the directory <code>Ml2pl_with_lib</code>. There is also a Bash script <code>ml2pl.sh</code> in the directory <code>Ml2pl_with_lib/Ml2pl</code>.</li>
<li>Decide where you want to keep the executable binary file <code>ml2pl</code> and move it there. (Or you can just leave it where it is, if you want.) We advise not to put it into a directory appearing in your environment variable <code>PATH</code>. This would not be convenient because you will not run <code>ml2pl</code> directly. Instead, you will invoke the script <code>ml2pl.sh</code>.</li>
<li>In the script <code>ml2pl.sh</code>, locate the line:
<pre>executable=...</pre>
Replace the ellipsis by the absolute path to the executable binary file <code>ml2pl</code>. For example:
<pre>executable=~/Ml2pl_with_lib/ml2pl</pre>
</li>
<li>It may be convenient to move the script <code>ml2pl.sh</code> to somewhere in your <code>PATH</code>.</li>
</ol>
<p><code>ml2pl</code> and <code>ml2pl.sh</code> are the only files you will need. So you can trash everything else if you want. (Be careful that if you type <code>make clean</code> in the top directory and <code>ml2pl</code> is still there then it will be deleted.)</p>
<h3>Usage</h3>
<p>Running the command with argument <code>-h</code> will produce a help message:</p>
<pre>$ ml2pl.sh -h
usage: ml2pl.sh [OPTION]... input-file output-file [pressure-file]

Interpolates NetCDF variables from model levels to pressure
levels. The interpolation is linear in logarithm of pressure. The
input variables depend on longitude, latitude, vertical level and
time. There is no constraint on the dimensions.

Options:
   -h                       : this help message
   -p variable              : name of 4-dimensional variable in the input file
                              or the pressure file containing the
                              pressure field at model levels
   -v variable[,variable...]: names of variables you want to interpolate, 
                              and possibly extrapolate if target pressure 
                              level is below surface
   -w variable[,variable...]: names of variables you want to interpolate, 
                              or set to 0 if target pressure level is below
                              surface
   -m variable[,variable...]: names of variables you want to interpolate, 
                              or set to missing if target pressure level is 
                              below surface

input-file, output-file and pressure-file are NetCDF files.

You must list the variables you want to interpolate, each variable
listed after either -v, -w or -m. There must be at least one variable
listed, following either -v, -w or -m.

The pressure field at model levels can be specified in input-file or
pressure-file either through hybrid coefficients and surface pressure
or directly from 4-dimensional pressure. In both cases, pressure must
be given in Pa and decrease when the index of model level
increases. This is checked quickly in the program. If option -p is not
used then the program will look for "ap", "bp" (hybrid
coefficients) and "ps" (surface pressure) in the input file or the
pressure file.

The target pressure levels should be in a text file called
"press_levels.txt" in the current directory at run-time. The first
line of the file is skipped, assuming it is a title line. Pressure
levels should be in hPa, in descending order, one value per
line. There is no constraint on these values nor on the number of
values.
</pre>
<p>Ci-joint <a class="internal-link" href="../press_levels.txt" title="press_levels.txt">un exemple de fichier <code>press_levels.txt</code></a>.</p>
